# Ticket Notes for January 2018

## Contents

* <a href="#lm-103696-white_check_mark">LM-103696 :white_check_mark:</a>
* <a href="#lm-105731-o">LM-105731 :o:</a>
* <a href="#lm-105869-white_check_mark">LM-105869 :white_check_mark:</a>
* <a href="#lm-103622-white_check_mark">LM-103622 :white_check_mark:</a>
* <a href="#lm-106022-o">LM-106022 :o:</a>

## LM-103696 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-103696?filter=-1
* **Description:** Refresh named account grid after linking
* **View:** /web/mkt-3.0/app/view/abm/namedAccount/NamedAccountHierachyGrid.js
* **Controller:**
  * /web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js
  * /web/mkt-3.0/app/controller/abm/namedAccount/LinkToNamedAccountForm.js
  
Create patch file in local environment:

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/LinkToNamedAccountForm.js > LM-103696.patch

# Patch to INT
patch -p0 < LM-103696.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-103696.patch

# Commit
svn commit -m "LM-103696 Refresh named account grid after linking." web/mkt-3.0/app/controller/abm/namedAccount/LinkToNamedAccountForm.js
```

## Refresh Grid after Creating Named Accounts

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/CreateForm.js > LM-XXX-refresh-hierachy-grid-after-creating-named-accounts.patch
# Patch to INT
patch -p0 < LM-XXX-refresh-hierachy-grid-after-creating-named-accounts.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-XXX-refresh-hierachy-grid-after-creating-named-accounts.patch
```

## LM-105731 :o:

* **URL:** https://resource.marketo.com/jira/browse/LM-105731?filter=-1
* **Description:** No error when trying to delete an account part of a Dynamic Account List
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js > LM-105731.patch

# Patch to INT
patch -p0 < LM-105731.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-105731.patch
```

## LM-105869 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-105869?filter=-1
* **Description:** Unlink menu greyout when at least one selected account is not linked
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js

```javascript
onGridSelectionChange: function(selectionModel) {
  var canvas = this.getGridCanvas(),
      toolbar = canvas.down('abmNamedAccountToolbar'),
      unlinkBtn = toolbar.down('[action=unlinkAccounts]'),
      selectedItems = selectionModel.selected.items;
      
  canvas.refreshState();
  
  // Check unlinked accounts
  // If at least one account has no parent, disable 'unlink' button.
  for (var i = 0; i < selectedItems.length; i++) {
    var currItem = selectedItems[i];
    if (isNaN(currItem.data.parentId)) {
      unlinkBtn.setDisabled(true);
      break;
    }
  }
},
```

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js > LM-105869.patch

# Patch to INT
patch -p0 < LM-105869.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-105869.patch

# Commit
svn commit -m "LM-105869 Unlink menu greyout when at least one selected account is not linked." web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js
```

## LM-103622 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-103622?filter=-1
* **Description:** Remove unnecessary calls in AccountListAccess.php class to APIs
* **File:** /apps/search/lib/data/AccountListAccess.php

How to test the number of API calls made in the php file (`AccountListAccess.php`):

1. Find out which function gets called in the php file to fetch the account list detail: `$accounts = $service->getAccountListById($accountListId);`.
2. Double click the function name and press `Command + B` to view its definition. We then have the function defined in `AbsService.php`.
3. Double click the function `getAccountListByIdURL()` in the definition of `getAccountListById()` and find its source code in `AbmServiceConfig.php`.
4. The function used a string `app_abm_service_get_account_list_by_id_url` in it. Search for `get_account_list_by_id_url` in `apps/search/config/app.yml`:

```
...
abm_service:
  ...
  # Account list operations
  get_account_lists_url: /v1/accountListManagement/munchkin/{munchkinId}/accountLists.json
  get_account_list_by_id_url: /v1/accountListManagement/munchkin/{munchkinId}/accountLists/{accountListId}/accountList.json
  ...  
```

So the API call is to fecth data from a file called `accountLists.json`. Then run the command: `tail -F log/bcabmintCustomer.log` and then click any account list. Search for `accountLists.json` in the log. It should show up twice, means that the API gets called twice.

Go to `/www/mkto` in the INT server and run the command: 

```bash
cd /Users/lqin/devdocker/mlm
svn diff apps/search/lib/data/AccountListAccess.php > LM-103622.patch

# Patch to INT
patch -p0 < LM-103622.patch
# Revert patch:
patch -p0 -R < LM-103622.patch

# Commit
svn commit -m "LM-103622 Remove unnecessary calls in AccountListAccess.php class to APIs." apps/search/lib/data/AccountListAccess.php
```

## LM-106022 :o:

* **URL:** https://resource.marketo.com/jira/browse/LM-106022?filter=-1
* **Description:** Includes children panel is unresponsive when tree is large
* **File:** 
    * /apps/search/modules/abm/actions/actions.class.php (line 2611)
    * /lib/abmService/transport/AbmService.php (line 595)
    
```bash
cd /Users/lqin/devdocker/mlm
svn diff apps/search/modules/abm/actions/actions.class.php > LM-106022.patch

# Patch to INT
patch -p0 < LM-106022.patch
# Revert patch:
patch -p0 -R < LM-106022.patch
```