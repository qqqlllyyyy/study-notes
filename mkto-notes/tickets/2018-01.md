# Ticket Notes for January 2018

## Contents

* <a href="#lm-103696-white_check_mark">LM-103696 :white_check_mark:</a>
    * Refresh named account grid after linking
* <a href="#lm-103697-white_check_mark">LM-103697 :white_check_mark:</a>
    * Refresh named account grid after unlinking
* <a href="#lm-106451-white_check_mark">LM-106451 :white_check_mark:</a>
    * Named account grid not getting refreshed dynamically after account is linked/unlinked
* <a href="#lm-105731-white_check_mark">LM-105731 :white_check_mark:</a>
    * No error when trying to delete an account part of a Dynamic Account List
* <a href="#lm-105869-white_check_mark">LM-105869 :white_check_mark:</a>
    * Unlink menu greyout when at least one selected account is not linked
* <a href="#lm-106507-o">LM-106507 :o:</a>
    * New rules for state of menu options based on selected row in NA Grid
* <a href="#lm-106513-o">LM-106513 :o:</a>
    * The link/unlink menus should not be enabled if there is a CRM account selected
* <a href="#lm-103622-white_check_mark">LM-103622 :white_check_mark:</a>
    * Remove unnecessary calls in AccountListAccess.php class to APIs
* <a href="#lm-106022-white_check_mark">LM-106022 :white_check_mark:</a>
    * Includes children panel is unresponsive when tree is large
* <a href="#lm-106210-white_check_mark">LM-106210 :white_check_mark:</a>
    * Paging still not working in Named Account Hierarchy Grid
* <a href="#lm-106057-o">LM-106057 :o:</a>
    * Score isn't shown on account details hierarchy tab
* <a href="#lm-106252-o">LM-106252 :o:</a>
    * Hierarchy tab is unresponsive after rendering 10k accounts
* <a href="#lm-106484-o">LM-106484 :o:</a>
    * Add descendants count next to account name in Hierarchy grid
* <a href="#lm-106484-o">LM-106501 :o:</a>
    * Append the string "Group" next to account name in all group rows in hierarchy

## LM-103696 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-103696?filter=-1
* **Description:** Refresh named account grid after linking
* **View:** /web/mkt-3.0/app/view/abm/namedAccount/NamedAccountHierachyGrid.js
* **Controller:**
  * /web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js
  * /web/mkt-3.0/app/controller/abm/namedAccount/LinkToNamedAccountForm.js
  
Create patch file in local environment:

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/LinkToNamedAccountForm.js > LM-103696.patch

# Patch to INT
patch -p0 < LM-103696.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-103696.patch

# Commit
svn commit -m "LM-103696 Refresh named account grid after linking." web/mkt-3.0/app/controller/abm/namedAccount/LinkToNamedAccountForm.js
```

## LM-103697 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-103697?filter=-1
* **Description:** Refresh named account grid after unlinking
* **View:** /web/mkt-3.0/app/view/abm/namedAccount/Toolbar.js
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js
  
Create patch file in local environment:

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js > LM-103697.patch

# Patch to INT
patch -p0 < LM-103697.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-103697.patch

# Commit
svn commit -m "LM-103697 Refresh named account grid after unlinking." web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js
```

## LM-106451 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-103697?filter=-1
* **Description:** Named account grid not getting refreshed dynamically after account is linked/unlinked
* **Controller:** /web/mkt-3.0/app/view/abm/namedAccount/NamedAccountHierarchyGrid.js

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js > LM-106451.patch

# Patch to INT
patch -p0 < LM-106451.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-106451.patch

# Commit
svn commit -m "LM-106451 Refresh named account fixed after linking/unlinking." web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js
```


## Refresh Grid after Creating Named Accounts

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/CreateForm.js > LM-XXX-refresh-hierachy-grid-after-creating-named-accounts.patch
# Patch to INT
patch -p0 < LM-XXX-refresh-hierachy-grid-after-creating-named-accounts.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-XXX-refresh-hierachy-grid-after-creating-named-accounts.patch
```

## LM-105731 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-105731?filter=-1
* **Description:** No error when trying to delete an account part of a Dynamic Account List
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js > LM-105731.patch

# Patch to INT
patch -p0 < LM-105731.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-105731.patch
# Commit
svn commit -m "LM-105731 Show error when trying to delete an account part of a Dynamic Account List" web/mkt-3.0/app/controller/abm/namedAccount/Toolbar.js
```

## LM-105869 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-105869?filter=-1
* **Description:** Unlink menu greyout when at least one selected account is not linked
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js

```javascript
onGridSelectionChange: function(selectionModel) {
  var canvas = this.getGridCanvas(),
      toolbar = canvas.down('abmNamedAccountToolbar'),
      unlinkBtn = toolbar.down('[action=unlinkAccounts]'),
      selectedItems = selectionModel.selected.items;
      
  canvas.refreshState();
  
  // Check unlinked accounts
  // If at least one account has no parent, disable 'unlink' button.
  for (var i = 0; i < selectedItems.length; i++) {
    var currItem = selectedItems[i];
    if (isNaN(currItem.data.parentId)) {
      unlinkBtn.setDisabled(true);
      break;
    }
  }
},
```

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js > LM-105869.patch

# Patch to INT
patch -p0 < LM-105869.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-105869.patch

# Commit
svn commit -m "LM-105869 Unlink menu greyout when at least one selected account is not linked." web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js
```

## LM-106507 :o:

* **URL:** https://resource.marketo.com/jira/browse/LM-106507?filter=-1
* **Description:** New rules for state of menu options based on selected row in NA Grid
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js

## LM-106513 :o:

* **URL:** https://resource.marketo.com/jira/browse/LM-106513?filter=-1
* **Description:** The link/unlink menus should not be enabled if there is a CRM account selected
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/NamedAccountHierarchyGrid.js

## LM-103622 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-103622?filter=-1
* **Description:** Remove unnecessary calls in AccountListAccess.php class to APIs
* **File:** /apps/search/lib/data/AccountListAccess.php

How to test the number of API calls made in the php file (`AccountListAccess.php`):

1. Find out which function gets called in the php file to fetch the account list detail: `$accounts = $service->getAccountListById($accountListId);`.
2. Double click the function name and press `Command + B` to view its definition. We then have the function defined in `AbsService.php`.
3. Double click the function `getAccountListByIdURL()` in the definition of `getAccountListById()` and find its source code in `AbmServiceConfig.php`.
4. The function used a string `app_abm_service_get_account_list_by_id_url` in it. Search for `get_account_list_by_id_url` in `apps/search/config/app.yml`:

```
...
abm_service:
  ...
  # Account list operations
  get_account_lists_url: /v1/accountListManagement/munchkin/{munchkinId}/accountLists.json
  get_account_list_by_id_url: /v1/accountListManagement/munchkin/{munchkinId}/accountLists/{accountListId}/accountList.json
  ...  
```

So the API call is to fecth data from a file called `accountLists.json`. Then run the command: `tail -F log/bcabmintCustomer.log` and then click any account list. Search for `accountLists.json` in the log. It should show up twice, means that the API gets called twice.

Go to `/www/mkto` in the INT server and run the command: 

```bashc
cd /Users/lqin/devdocker/mlm
svn diff apps/search/lib/data/AccountListAccess.php > LM-103622.patch

# Patch to INT
patch -p0 < LM-103622.patch
# Revert patch:
patch -p0 -R < LM-103622.patch

# Commit
svn commit -m "LM-103622 Remove unnecessary calls in AccountListAccess.php class to APIs." apps/search/lib/data/AccountListAccess.php
```

## LM-106022 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-106022?filter=-1
* **Description:** Includes children panel is unresponsive when tree is large
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/IncludesChildrenPanel.js
* **Backend Files:** 
    * /apps/search/modules/abm/actions/actions.class.php (line 2611)
    * /lib/abmService/transport/AbmService.php (line 595)

It works fine on Firefox and Safari, only slow on Chrome. Related post: https://www.sencha.com/forum/showthread.php?309824-Normal-grid-scrolling-is-very-slow-after-sew-smooth-scrolling-feature-in-chrome

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/view/abm/namedAccount/IncludesChildrenPanel.js > LM-106022.patch

# Patch to INT
patch -p0 < LM-106022.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-106022.patch

# Commit
svn commit -m "LM-106022 Improved the performance by allowing only one subtree can be expanded in the same level." web/mkt-3.0/app/view/abm/namedAccount/IncludesChildrenPanel.js
```

## LM-106210 :white_check_mark:

* **URL:** https://resource.marketo.com/jira/browse/LM-106210?filter=-1
* **Description:** Paging still not working in Named Account Hierarchy Grid
* **Backend Files:** /lib/abmService/transport/AbmService.php (line 595)
    
```bash
cd /Users/lqin/devdocker/mlm
svn diff lib/abmService/transport/AbmService.php > LM-106210.patch

# Patch to INT
patch -p0 < LM-106210.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-106210.patch

# Commit
svn commit -m "LM-106210 Updated totalCount and paging works in NamedAccountHierarchyGrid" lib/abmService/transport/AbmService.php
```

## LM-106057 :o:

* **URL:** https://resource.marketo.com/jira/browse/LM-106057?filter=-1
* **Description:** Score isn't shown on account details hierarchy tab

## LM-106252 :o:

* **URL:** https://resource.marketo.com/jira/browse/LM-106252?filter=-1
* **Description:** Hierarchy tab is unresponsive after rendering 10k accounts
* **Controller:** /web/mkt-3.0/app/controller/abm/namedAccount/Dashboard.js
* **View:** /web/mkt-3.0/app/view/abm/namedAccount/Hierarchy.js

Related posts: https://www.sencha.com/forum/showthread.php?280879-Ext-Js-Tree-Panel-Expand-and-Select-a-deeper-node

Updates I made to improve the performance:

1. Expand only the subtree that contains the selected named account, other subtrees collapsed
2. Scroll to the node and it is highlighted
3. Highlight the selected named account
4. Removed the animation when expanding the tree (so that auto-scroll works)

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/* > LM-106252.patch

# Patch to INT
patch -p0 < LM-106252.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-106252.patch
```

## LM-106484 :o:

* **URL:** https://resource.marketo.com/jira/browse/LM-106484?filter=-1
* **Description:** Add descendants count next to account name in Hierarchy grid
* **View:** /web/mkt-3.0/app/view/abm/namedAccount/NamedAccountGrid.js

Wait for the backend API to return the number of total descendants for a named account.

## LM-106501 :o:

* **URL:** https://resource.marketo.com/jira/browse/LM-106501?filter=-1
* **Description:** Append the string "Group" next to account name in all group rows in hierarchy
* **View:** /web/mkt-3.0/app/view/abm/namedAccount/NamedAccountGrid.js

```bash
cd /Users/lqin/devdocker/mlm
svn diff web/mkt-3.0/app/view/abm/namedAccount/NamedAccountGrid.js > LM-106501.patch

# Patch to INT
patch -p0 < LM-106501.patch
php batch/compressScripts.php
# Revert patch:
patch -p0 -R < LM-106501.patch
```